---
title: Scraping the MMWR with rvest
author: Monica Gerber
date: '2018-03-18'
slug: scraping-the-mmwr-with-rvest
categories:
  - webscraping
  - public health
tags:
  - mmwr rvest
draft: true
---



<div id="rvest-in-action" class="section level2">
<h2>rvest in action</h2>
<p>First, we need to create a html document from the URL of the page we want using <code>read_html()</code>.</p>
<pre class="r"><code>library(rvest)
cdc_site &lt;- read_html(&quot;http://www.cdc.gov/mmwr/volumes/65/wr/mm6545a2.htm?s_cid=mm6545a2_w&quot;)</code></pre>
<p>After we have the html document, we need to select part of the document using CSS selectors. I read up on selectorgadget (see rvest, /Library/Frameworks/R.framework/Versions/3.4/Resources/library/rvest, selectorgadget, selectorgadget.Rmd, Selectorgadget, selectorgadget.R, selectorgadget.html) to help me figure out which selector to use. However, for this task, I found it easier to just extract the type of element we want, which is the table.</p>
<p>We can use <code>html_node()</code> to extract the table in the html document. Then, we use <code>html_table()</code> to parse the html table into a data frame. Note that if there were more than 1 table, we could use <code>html_nodes()</code>, and then select which table we want with either <code>magrittr::extract2()</code> or <code>[[</code>. We set <code>fill = TRUE</code> because the columns in the the top row are merged and contain headings.</p>
<pre class="r"><code>library(magrittr)
wic_table &lt;- cdc_site %&gt;%
  html_node(&quot;table&quot;)  %&gt;% 
  html_table(fill = TRUE)</code></pre>
<p>That’s pretty cool that we can get the data into a data frame in just a few lines of code!</p>
</div>
<div id="clean-up" class="section level2">
<h2>clean up</h2>
<p>We’ve successfully scrapped the data, but now our problem is that the data frame consists of character varibles because there were 3 rows of column headers:</p>
<pre class="r"><code>str(wic_table)</code></pre>
<p>First I’ll rename everything using <code>set_names()</code> from magrittr. And then I’ll clean this up using functions from dplyr and tidyr from the tidyverse.</p>
<pre class="r"><code>library(tidyverse)

tidy_wic &lt;- wic_table %&gt;%
  set_names(c(&quot;state&quot;,
              &quot;n_2000&quot;,
               &quot;n_2004&quot;,
               &quot;n_2010&quot;,
               &quot;n_2014&quot;,
               &quot;obesity_2000&quot;,
               &quot;obesity_2004&quot;,
               &quot;obesity_2010&quot;,
               &quot;obesity_2014&quot;,
               &quot;dif_2004&quot;,
               &quot;dif_2010&quot;,
               &quot;dif_2014&quot;)) %&gt;%
  filter(row_number() &gt; 2,
         state != &quot;Territory&quot;) %&gt;%
  gather(key, measure, -state) %&gt;%
  separate(key, into = c(&quot;stat&quot;, &quot;year&quot;), sep = &quot;_&quot;) %&gt;%
  spread(key = stat, value = measure) %&gt;%
  separate(dif, into = c(&quot;dif&quot;, &quot;ci&quot;), sep = &quot; &quot;, extra = &quot;merge&quot;) %&gt;%
  separate(ci, into = c(&quot;lower_ci&quot;, &quot;upper_ci&quot;), sep = &quot; to &quot;) %&gt;%
  mutate_at(vars(n, dif, lower_ci, upper_ci, obesity), parse_number) %&gt;%
  as_tibble() </code></pre>
<p>Ta-da! It’s now in a much more usable format!</p>
</div>
<div id="visualize" class="section level2">
<h2>visualize</h2>
<p>Now that it’s in a tidy format, we can create our own data visualizations.</p>
<p><a href="https://hafen.github.io/geofacet/">geofacet</a></p>
<p><a href="https://talks.cpsievert.me/20180202/#23">plotly</a></p>
<pre class="r"><code>library(leaflet)
library(sp)
library(geojson)
library(geojsonio)
url &lt;- &quot;http://leafletjs.com/examples/choropleth/us-states.js&quot;

# read as text file
doc &lt;- readLines(url)

# remove the javascript assignment at the front 
doc2 &lt;- gsub(&quot;var statesData = &quot;, &quot;&quot;, doc)

# write out as a temp file and read
write(doc2, file = &quot;tempgeo.json&quot;)
states &lt;- geojson_read(&quot;tempgeo.json&quot;, what = &quot;sp&quot;)

# ^ found out how to get this data into R thanks to this stack overflow post! 
# https://stackoverflow.com/questions/43443260/how-to-download-geojson-data-and-read-it-to-r

# merge data
# first filter out non-states

wic_states &lt;- tidy_wic %&gt;%
  filter(!state %in% c(&quot;DC&quot;, &quot;Overall¶&quot;, &quot;Northern Mariana Islands&quot;,
                       &quot;Puerto Rico&quot;, &quot;Virgin Islands&quot;, &quot;Guam&quot;,
                       &quot;American Samoa&quot;)) %&gt;%
  filter(year == &quot;2014&quot;)

wic_sp &lt;- merge(states, wic_states, 
                by.x = &quot;name&quot;, by.y = &quot;state&quot;,
                duplicateGeoms = TRUE)

bins &lt;- c(7, 12.66, 13.52, 14.78, 16.3, 20)
pal &lt;- colorBin(&quot;YlOrRd&quot;, domain = wic_sp$obesity, bins = bins)

labels &lt;- sprintf(
  &quot;&lt;strong&gt;%s&lt;/strong&gt;&quot;,
  wic_sp$obesity
) %&gt;% lapply(htmltools::HTML)

wic_sp %&gt;%
  leaflet() %&gt;%
  setView(-96, 37.8, 4) %&gt;%
  addTiles() %&gt;%
  addPolygons(
  fillColor = ~pal(obesity),
  weight = 2,
  opacity = 1,
  color = &quot;white&quot;,
  dashArray = &quot;3&quot;,
  fillOpacity = 0.7)

wic_states %&gt;% 
  summarise(`20%`=quantile(obesity, probs=0.20),
            `40%`=quantile(obesity, probs=0.4),
            `60%`=quantile(obesity, probs=0.60),
            `80%`=quantile(obesity, probs=0.80))</code></pre>
<pre class="r"><code>html_doc &lt;- read_html(&quot;https://www.cdc.gov/mmwr/volumes/67/wr/mm6706a3.htm?s_cid=mm6706a3_w&quot;)

obesity_table &lt;- html_doc %&gt;%
  html_node(&quot;table&quot;)  %&gt;% 
  html_table(fill = TRUE)</code></pre>
<pre class="r"><code>library(rvest)
library(tidyverse)

mmwr_site &lt;- read_html(&quot;https://www.cdc.gov/mmwr/mmwr_wk/wk_pvol.html&quot;)

css &lt;- paste0(paste0(&quot;#anch_&quot;, 13:47), collapse=&quot;, &quot;)

issues &lt;- mmwr_site %&gt;%
  html_nodes(css = css) %&gt;%
  html_attr(&quot;href&quot;)

issues[1:3] &lt;- paste0(&quot;https://www.cdc.gov&quot;, issues[1:3])


test &lt;- read_html(issues[1]) %&gt;%
  html_nodes(css = &quot;ul:nth-child(10) li&quot;) </code></pre>
<pre class="r"><code>library(RISmed)

myquery &lt;- &quot;MMWR. Morbidity and mortality weekly report[Journal]&quot;

search_query &lt;- EUtilsSummary(myquery, 
                              type = &quot;esearch&quot;,
                              db = &quot;pubmed&quot;)
summary(search_query)

records &lt;- EUtilsGet(search_query)

pubmed_data &lt;- data.frame(&#39;title&#39; = ArticleTitle(records),
                      &#39;abstract&#39; = AbstractText(records))</code></pre>
</div>
